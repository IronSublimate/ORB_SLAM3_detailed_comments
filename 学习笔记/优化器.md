# Tracking相关

## GlobalBundleAdjustemnt&BundleAdjustment

### 调用时机

`GlobalBundleAdjustemnt`调用`BundleAdjustment`
`GlobalBundleAdjustemnt`

1. Tracking中单目三角化成功，全局BA优化，同时优化所有位姿和三维点
2. LoopClosing中 MergeLocal CorrectLoop 中调用

### 优化变量

所有地图点和位姿

## FullInertialBA

### 调用时机

1. LocalMapping中 IMU初始化中调用
2. LoopClosing中 MergeLocal CorrectLoop 中调用，和上面`GlobalBundleAdjustemnt`互补

### 优化变量

## PoseOptimization

### 调用时机

只在Tracking中用了，只优化位姿，不优化地图点

1. 跟踪
    1. 根据恒速模型优化3D-2D位姿
    2. 根据参考关键帧优化3D-2D位姿
2. 重定位的的时候优化位姿
    1. 重定位开始的时候，先优化一下
    2. 重定位的时候，如果内点较少，则通过投影的方式对之前未匹配的点进行匹配，再进行优化求解
    3. 重定位的的时候，如果成功挽救回来，匹配数目达到要求，最后BA优化一下
3. TrackingLocalMap中，在IMU未初始化或IMU reset之后，使用它优化位姿
### 优化变量

位姿

## PoseInertialOptimizationLastKeyFrame

### 调用时机

Tracking中TrackLocalMap，使用上一关键帧以及当前帧的视觉信息和IMU信息联合优化当前帧位姿、速度和IMU零偏

## PoseInertialOptimizationLastFrame

### 调用时机

Tracking中TrackLocalMap，使用上一帧以及当前帧的视觉信息和IMU信息联合优化当前帧位姿、速度和IMU零偏

# LocalMapping相关

## LocalBundleAdjustment

一共2个同名函数

```cpp
void Optimizer::LocalBundleAdjustment(KeyFrame *pKF, bool* pbStopFlag, Map* pMap, int& num_fixedKF, int& num_OptKF, int& num_MPs, int& num_edges)
void Optimizer::LocalBundleAdjustment(KeyFrame* pMainKF,vector<KeyFrame*> vpAdjustKF, vector<KeyFrame*> vpFixedKF, bool *pbStopFlag)
```

### 调用时机

1. LocalMapping 在没有IMU或IMU未初始化的情况下BA
2. LoopClosing中的MergeLocal 运行的 welding BA , 优化所有的当前关键帧共视窗口里的关键帧和地图点, 固定所有融合帧共视窗口里的帧

### 优化变量

## LocalInertialBA

### 调用时机

LocalMapping 在有IMU初始化的情况下BA 和上面的那个`LocalBundleAdjustment`(1)互补

### 优化变量

## [MergeInertialBA](#MergeInertialBA)

LoopClosing中的MergeLocal在有IMU的时候，和上面那个`LocalBundleAdjustment`(2)互补

## InertialOptimization

一共3个同名函数

```c++
void Optimizer::InertialOptimization(Map *pMap, Eigen::Matrix3d &Rwg, double &scale, Eigen::Vector3d &bg, Eigen::Vector3d &ba, bool bMono, Eigen::MatrixXd  &covInertial, bool bFixedVel, bool bGauss, float priorG, float priorA)
void Optimizer::InertialOptimization(Map *pMap, Eigen::Vector3d &bg, Eigen::Vector3d &ba, float priorG, float priorA)
void Optimizer::InertialOptimization(Map *pMap, Eigen::Matrix3d &Rwg, double &scale)
```

### 调用时机

1. LocalMapping中的InitializeIMU
2. LoopClosing中MergeLocal2
3. LocalMapping中的ScalRefinement 优化重力方向与尺度  
   单目情况下，在关键帧小于200时，会在满足一定时间间隔后多次进行尺度、重力方向优化

# LoopClosing相关

## [GlobalBundleAdjustemnt](#GlobalBundleAdjustemnt\&BundleAdjustment)

## [FullInertialBA](#FullInertialBA)

## [InertialOptimization](#InertialOptimization)

## [LocalBundleAdjustment](#LocalBundleAdjustment)

## MergeInertialBA

### 调用时机

LoopClosing中的MergeLocal在有IMU的时候，和上面那个`LocalBundleAdjustment`(2)互补  
运行的 welding BA , 优化所有的当前关键帧共视窗口里的关键帧和地图点, 固定所有融合帧共视窗口里的帧

## OptimizeSim3

### 调用时机

1. LoopCLosing中DetectAndReffineSim3FromLastKF优化
2. LoopCLosing中DetectCommonRegionsFromBoW优化

## OptimizeEssentialGraph

一共两个同名函数

```c++
void Optimizer::OptimizeEssentialGraph(Map* pMap, KeyFrame* pLoopKF, KeyFrame* pCurKF,
                                       const LoopClosing::KeyFrameAndPose &NonCorrectedSim3,
                                       const LoopClosing::KeyFrameAndPose &CorrectedSim3,
                                       const map<KeyFrame *, set<KeyFrame *> > &LoopConnections, const bool &bFixScale)
void Optimizer::OptimizeEssentialGraph(KeyFrame* pCurKF, vector<KeyFrame*> &vpFixedKFs, vector<KeyFrame*> &vpFixedCorrectedKFs,
                                       vector<KeyFrame*> &vpNonFixedKFs, vector<MapPoint*> &vpNonCorrectedMPs)                                     
```

### 调用时机

LoopClosing中

## OptimizeEssentialGraph4DoF

### 调用时机

LoopClosing中，在有IMU的情况下，和上面的那个`OptimizeEssentialGraph`(1)互补